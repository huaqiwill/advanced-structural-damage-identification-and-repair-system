{% extends "base.html" %}

{% block title %}水面垃圾检测警报 - 结构损伤的高级识别和绘图{% endblock %}

{% block extra_css %}
<style>
    .main-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .alert-section {
        background-color: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid #e0e0e0;
    }
    
    .stats-section {
        background-color: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid #e0e0e0;
    }
    
    .history-section {
        background-color: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid #e0e0e0;
    }
    
    .stats-card {
        text-align: center;
        padding: 1.5rem;
        border-radius: 10px;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .stats-card .number {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--theme-color);
    }
    
    .stats-card .label {
        color: #6c757d;
        font-size: 1rem;
    }
    
    .stats-card-primary .number {
        color: var(--theme-color);
    }
    
    .stats-card-secondary .number {
        color: #0d6efd;
    }
    
    .chart-container {
        height: 300px;
        margin-top: 20px;
    }
    
    .status-badge {
        width: 80px;
        text-align: center;
    }
    
    .badge-high {
        background-color: #dc3545;
    }
    
    .badge-medium {
        background-color: #fd7e14;
    }
    
    .badge-low {
        background-color: #0dcaf0;
    }
    
    .history-table th {
        font-weight: 600;
        background-color: #f8f9fa;
    }
    
    .tip-box {
        background-color: #e7f5ff;
        border-left: 4px solid #0d6efd;
        padding: 15px;
        margin-top: 20px;
        border-radius: 4px;
    }
    
    .detection-type-stats {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }
    
    .detection-type-card {
        flex: 1;
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .detection-type-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .detection-type-card h6 {
        color: #6c757d;
        margin-bottom: 10px;
    }
    
    .detection-type-card .count {
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--theme-color);
    }
    
    .no-data-message {
        text-align: center;
        padding: 50px 0;
    }
    
    .no-data-message i {
        font-size: 4rem;
        color: #e0e0e0;
        margin-bottom: 15px;
    }
    
    .no-data-message p {
        color: #6c757d;
        font-size: 1.1rem;
    }
    
    @media (max-width: 768px) {
        .detection-type-stats {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="page-header">
        <h2 class="display-5 fw-bold text-theme">水面检测警报</h2>
        <p class="lead text-muted">查看水面区域的检测记录和统计信息</p>
    </div>
    
    <!-- 警报统计信息区域 -->
    <div class="row">
        <div class="col-md-12">
            <div class="stats-section">
                <h5 class="mb-4">统计信息</h5>
                
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="stats-card stats-card-primary">
                            <div class="number" id="totalAlerts">0</div>
                            <div class="label">总警报数</div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="stats-card stats-card-secondary">
                            <div class="number" id="todayAlerts">0</div>
                            <div class="label">今日警报</div>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="alertsChart"></canvas>
                </div>
                
                <div class="detection-type-stats">
                    <div class="detection-type-card">
                        <h6>图片检测</h6>
                        <div class="count" id="imageCount">0</div>
                    </div>
                    <div class="detection-type-card">
                        <h6>视频检测</h6>
                        <div class="count" id="videoCount">0</div>
                    </div>
                    <div class="detection-type-card">
                        <h6>批量检测</h6>
                        <div class="count" id="multiImageCount">0</div>
                    </div>
                    <div class="detection-type-card">
                        <h6>摄像头检测</h6>
                        <div class="count" id="cameraCount">0</div>
                    </div>
                </div>
                
                <div class="tip-box mt-4">
                    <i class="fas fa-info-circle me-2"></i>
                    当系统检测到垃圾时会自动创建警报，以标记可能的污染水面区域。
                </div>
            </div>
        </div>
    </div>
    
    <!-- 历史警报列表区域 -->
    <div class="row">
        <div class="col-md-12">
            <div class="history-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">垃圾检测记录</h5>
                    <button class="btn btn-outline-theme" id="refreshBtn">
                        <i class="fas fa-sync-alt me-1"></i> 刷新
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover history-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>检测类型</th>
                                <th>文件名</th>
                                <th>检测时间</th>
                                <th>清理状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="alertHistoryTable">
                            <!-- 数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div id="recordStats" class="text-muted small">
                        共 <span id="totalRecords">0</span> 条记录
                    </div>
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm mb-0" id="alertPagination">
                            <!-- 分页将通过JavaScript动态生成 -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 警报详情模态框 -->
<div class="modal fade" id="alertDetailModal" tabindex="-1" aria-labelledby="alertDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alertDetailModalLabel">检测详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>原始文件</h6>
                        <!-- 图片或视频容器 -->
                        <div id="originalMediaContainer">
                            <img src="" alt="原始图像" id="originalImage" class="img-fluid mb-3 border rounded">
                            <video src="" id="originalVideo" class="img-fluid mb-3 border rounded" style="display:none;" controls></video>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>检测结果</h6>
                        <!-- 图片或视频容器 -->
                        <div id="resultMediaContainer">
                            <img src="" alt="检测结果" id="resultImage" class="img-fluid mb-3 border rounded">
                            <video src="" id="resultVideo" class="img-fluid mb-3 border rounded" style="display:none;" controls></video>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info">
                    <strong>检测结果：</strong> <span id="detectionResultText">未检测到垃圾 (total_objects = 0)</span>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <p><strong>检测ID：</strong> <span id="detailId"></span></p>
                        <p><strong>文件名：</strong> <span id="detailFilename"></span></p>
                        <p><strong>检测类型：</strong> <span id="detailType"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>检测时间：</strong> <span id="detailTimestamp"></span></p>
                        <p><strong>处理状态：</strong> <span id="detailStatus"></span></p>
                        <p><strong>处理耗时：</strong> <span id="detailDuration"></span> 秒</p>
                    </div>
                </div>
                
                <!-- 新增：检测到的垃圾坐标信息 -->
                <div class="row mt-3" id="coordinatesContainer" style="display:none;">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2 mb-3">检测到的垃圾坐标信息</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>垃圾类型</th>
                                        <th>置信度</th>
                                        <th>坐标 (左上角)</th>
                                        <th>坐标 (右下角)</th>
                                        <th>尺寸 (宽x高)</th>
                                    </tr>
                                </thead>
                                <tbody id="coordinatesTableBody">
                                    <!-- 坐标数据将通过JavaScript动态添加 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 获取DOM元素
        const totalAlertsElement = document.getElementById('totalAlerts');
        const todayAlertsElement = document.getElementById('todayAlerts');
        const imageCountElement = document.getElementById('imageCount');
        const videoCountElement = document.getElementById('videoCount');
        const multiImageCountElement = document.getElementById('multiImageCount');
        const cameraCountElement = document.getElementById('cameraCount');
        const alertHistoryTable = document.getElementById('alertHistoryTable');
        const totalRecordsElement = document.getElementById('totalRecords');
        const refreshBtn = document.getElementById('refreshBtn');
        const alertDetailModal = new bootstrap.Modal(document.getElementById('alertDetailModal'));
        
        // 当前页码
        let currentPage = 1;
        let totalPages = 1;
        let currentRecordId = null;
        
        // 初始化
        loadAlertStatistics();
        loadAlerts(currentPage);
        
        // 刷新按钮
        refreshBtn.addEventListener('click', function() {
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> 刷新中...';
            refreshBtn.disabled = true;
            
            // 刷新数据
            loadAlertStatistics();
            loadAlerts(currentPage);
            
            setTimeout(function() {
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i> 刷新';
                refreshBtn.disabled = false;
            }, 1000);
        });
        
        // 加载警报统计数据
        function loadAlertStatistics() {
            fetch('/api/alerts/statistics')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 更新统计卡片
                        totalAlertsElement.textContent = data.data.total_alerts;
                        todayAlertsElement.textContent = data.data.today_alerts;
                        imageCountElement.textContent = data.data.image_count;
                        videoCountElement.textContent = data.data.video_count;
                        multiImageCountElement.textContent = data.data.multi_image_count;
                        cameraCountElement.textContent = data.data.camera_count || 0;
                        
                        // 更新图表
                        updateChart(data.data.daily_stats);
                    } else {
                        console.error('加载统计数据失败:', data.message);
                    }
                })
                .catch(error => {
                    console.error('加载警报统计数据失败:', error);
                });
        }
        
        // 加载警报列表
        function loadAlerts(page = 1, perPage = 10) {
            fetch(`/api/alerts?page=${page}&per_page=${perPage}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 更新表格数据
                        updateAlertTable(data.data.alerts);
                        
                        // 更新总记录数
                        totalRecordsElement.textContent = data.data.total || 0;
                        
                        // 更新分页
                        currentPage = data.data.current_page;
                        totalPages = data.data.pages;
                        updatePagination(currentPage, totalPages);
                    } else {
                        console.error('加载警报列表失败:', data.message);
                    }
                })
                .catch(error => {
                    console.error('加载警报列表失败:', error);
                });
        }
        
        // 更新警报表格
        function updateAlertTable(alerts) {
            if (!alertHistoryTable) return;
            
            if (!alerts || alerts.length === 0) {
                alertHistoryTable.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="no-data-message">
                                <i class="fas fa-water d-block"></i>
                                <p>暂无垃圾检测记录</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // 清空表格
            alertHistoryTable.innerHTML = '';
            
            // 添加数据行
            alerts.forEach((alert, index) => {
                const statusClass = alert.status === '已处理' ? 'bg-success' : 'bg-warning';
                
                // 格式化检测类型
                let alertTypeText = alert.alert_type;
                switch (alert.alert_type) {
                    case 'image':
                        alertTypeText = '图片检测';
                        break;
                    case 'video':
                        alertTypeText = '视频检测';
                        break;
                    case 'multi_image':
                        alertTypeText = '批量图片检测';
                        break;
                    case 'camera':
                        alertTypeText = '摄像头检测';
                        break;
                }
                
                // 计算序号：(当前页码-1) * 每页记录数 + 当前索引 + 1
                const sequentialId = (currentPage - 1) * 10 + index + 1; // 假设每页10条记录
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${sequentialId}</td>
                    <td><span class="badge bg-primary">${alertTypeText}</span></td>
                    <td>${alert.source}</td>
                    <td>${alert.timestamp}</td>
                    <td><span class="badge ${statusClass} status-badge">${alert.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-theme view-alert" data-id="${alert.id}" data-original="${alert.original_path}" data-result="${alert.result_path}" data-bs-toggle="tooltip" title="查看详情">
                            <i class="fas fa-eye"></i> 查看
                        </button>
                    </td>
                `;
                alertHistoryTable.appendChild(row);
            });
            
            // 添加事件监听器
            document.querySelectorAll('.view-alert').forEach(btn => {
                btn.addEventListener('click', function() {
                    const recordId = this.getAttribute('data-id');
                    const originalPath = this.getAttribute('data-original');
                    const resultPath = this.getAttribute('data-result');
                    
                    // 打开详情模态框
                    showRecordDetail(recordId, originalPath, resultPath);
                });
            });
            
            // 初始化工具提示
            const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltips.forEach(tooltip => {
                new bootstrap.Tooltip(tooltip);
            });
        }
        
        // 显示记录详情
        function showRecordDetail(recordId, originalPath, resultPath) {
            currentRecordId = recordId;
            
            // 调试信息
            console.log('显示详情:', recordId);
            console.log('原始路径:', originalPath);
            console.log('结果路径:', resultPath);
            
            // 获取表格中显示的序号
            let displayId = null;
            document.querySelectorAll('#alertHistoryTable tr').forEach((row, index) => {
                const btnId = row.querySelector('.view-alert')?.getAttribute('data-id');
                if (btnId === recordId.toString()) {
                    // 获取第一个单元格的文本内容（序号）
                    displayId = row.querySelector('td:first-child').textContent;
                }
            });
            
            // 先重置坐标显示区域
            document.getElementById('coordinatesContainer').style.display = 'none';
            document.getElementById('coordinatesTableBody').innerHTML = '';
            
            // 显示加载中状态
            document.getElementById('alertDetailModalLabel').textContent = '加载详情中...';
            alertDetailModal.show();
            
            // 修改为使用专用详情API，确保获取特定ID的记录
            fetch(`/api/detection_records/${recordId}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success || !data.data) {
                        console.error('没有找到记录或API格式不正确');
                        document.getElementById('alertDetailModalLabel').textContent = '加载失败';
                        return;
                    }
                    
                    // 确保使用API返回的特定ID记录
                    const record = data.data;
                    console.log('获取到的记录数据:', record);
                    
                    try {
                        // 更新模态框标题
                        document.getElementById('alertDetailModalLabel').textContent = `检测详情 #${displayId || record.id}`;
                        
                        // 如果路径不是以/static开头，添加/static前缀
                        if (originalPath && !originalPath.startsWith('/static')) {
                            originalPath = '/static' + originalPath;
                        }
                        
                        if (resultPath && !resultPath.startsWith('/static')) {
                            resultPath = '/static' + resultPath;
                        }
                        
                        // 修复camera相关文件的路径
                        if (originalPath && originalPath.includes('user_camera_original') && !originalPath.includes('/camera/')) {
                            // 将/static/uploads/user_camera_original替换为/static/uploads/camera/user_camera_original
                            originalPath = originalPath.replace('/static/uploads/', '/static/uploads/camera/');
                            console.log('修正后的原始路径:', originalPath);
                        }
                        
                        if (resultPath && resultPath.includes('user_camera_result') && !resultPath.includes('/camera/')) {
                            // 将/static/uploads/user_camera_result替换为/static/uploads/camera/user_camera_result
                            resultPath = resultPath.replace('/static/uploads/', '/static/uploads/camera/');
                            console.log('修正后的结果路径:', resultPath);
                        }
                        
                        // 修复结果视频路径中的/camera/results/为/camera/
                        if (resultPath && resultPath.includes('/camera/results/')) {
                            resultPath = resultPath.replace('/camera/results/', '/camera/');
                            console.log('移除results子目录后的结果路径:', resultPath);
                        }
                        
                        console.log('处理后原始路径:', originalPath);
                        console.log('处理后结果路径:', resultPath);
                        
                        // 获取文件扩展名
                        const getFileExtension = (filename) => {
                            if (!filename) return '';
                            return filename.toLowerCase().split('.').pop();
                        };
                        
                        // 判断是否为视频文件
                        const isVideoFile = (filename) => {
                            if (!filename) return false;
                            
                            // 严格检查视频扩展名
                            const videoExtensions = ['mp4', 'avi', 'mov', 'webm', 'mkv', 'flv', 'wmv'];
                            const ext = getFileExtension(filename);
                            
                            // 确保不将图片当做视频
                            const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
                            if (imageExtensions.includes(ext)) {
                                return false; // 如果是图片扩展名，确保返回false
                            }
                            
                            return videoExtensions.includes(ext);
                        };
                        
                        // 检查原始文件和结果文件是否为视频
                        const originalIsVideo = originalPath && isVideoFile(originalPath);
                        const resultIsVideo = resultPath && isVideoFile(resultPath);
                        
                        console.log('原始文件是视频?', originalIsVideo);
                        console.log('结果文件是视频?', resultIsVideo);
                        
                        // 设置原始文件预览
                        const originalImage = document.getElementById('originalImage');
                        const originalVideo = document.getElementById('originalVideo');
                        
                        if (originalImage && originalVideo) {
                            if (originalIsVideo) {
                                // 显示视频
                                originalImage.style.display = 'none';
                                originalVideo.style.display = 'block';
                                originalVideo.src = originalPath || '';
                                
                                // 添加错误处理
                                originalVideo.onerror = function() {
                                    console.error('视频加载失败:', originalPath);
                                    originalVideo.style.display = 'none';
                                    originalImage.style.display = 'block';
                                    originalImage.src = '/static/img/placeholder.png'; // 使用通用占位图
                                };
                            } else {
                                // 显示图片 - 确保src设置正确
                                originalVideo.style.display = 'none';
                                originalImage.style.display = 'block';
                                
                                // 直接设置图片路径 - 确保不是空值
                                console.log('设置原始图片路径:', originalPath);
                                originalImage.src = originalPath || '/static/img/placeholder.png';
                                
                                // 添加图片加载错误处理
                                originalImage.onerror = function() {
                                    console.error('图片加载失败:', originalPath);
                                    originalImage.src = '/static/img/placeholder.png';
                                };
                            }
                        }
                        
                        // 设置结果文件预览
                        const resultImage = document.getElementById('resultImage');
                        const resultVideo = document.getElementById('resultVideo');
                        
                        if (resultImage && resultVideo) {
                            if (resultIsVideo) {
                                // 显示视频
                                resultImage.style.display = 'none';
                                resultVideo.style.display = 'block';
                                resultVideo.src = resultPath || '';
                                
                                // 添加错误处理
                                resultVideo.onerror = function() {
                                    console.error('结果视频加载失败:', resultPath);
                                    resultVideo.style.display = 'none';
                                    resultImage.style.display = 'block';
                                    resultImage.src = '/static/img/placeholder.png';
                                };
                            } else {
                                // 显示图片
                                resultVideo.style.display = 'none';
                                resultImage.style.display = 'block';
                                
                                // 直接设置图片路径
                                console.log('设置结果图片路径:', resultPath);
                                resultImage.src = resultPath || '/static/img/placeholder.png';
                                
                                // 添加图片加载错误处理
                                resultImage.onerror = function() {
                                    console.error('结果图片加载失败:', resultPath);
                                    resultImage.src = '/static/img/placeholder.png';
                                };
                            }
                        }
                        
                        // 更新其他信息 - 添加null检查
                        const updateElementText = (id, text) => {
                            const element = document.getElementById(id);
                            if (element) {
                                element.textContent = text;
                            }
                        };
                        
                        updateElementText('detailId', displayId || record.id); // 使用表格中的序号而不是数据库ID
                        updateElementText('detailFilename', record.source_name);
                        updateElementText('detailType', formatSourceType(record.source_type));
                        updateElementText('detailTimestamp', record.timestamp);
                        updateElementText('detailStatus', record.is_cleaned ? '已清理' : '待清理');
                        updateElementText('detailDuration', record.duration ? record.duration.toFixed(2) : 'N/A');
                        
                        // 更新检测结果文本
                        const totalObjects = record.total_objects || 0;
                        updateElementText('detectionResultText', 
                            totalObjects > 0 ? `检测到 ${totalObjects} 个垃圾` : '未检测到垃圾 (total_objects = 0)');
                        
                        // 处理并显示垃圾坐标信息
                        if (record.detection_results || record.metadata) {
                            try {
                                // 尝试从detection_results或metadata获取对象数据
                                let detectionObjects = [];
                                
                                if (record.detection_results) {
                                    const detectionResults = typeof record.detection_results === 'string' 
                                        ? JSON.parse(record.detection_results) 
                                        : record.detection_results;
                                    
                                    if (detectionResults.objects && detectionResults.objects.length > 0) {
                                        detectionObjects = detectionResults.objects;
                                    }
                                }
                                
                                // 如果detection_results中没有找到objects，尝试从metadata中获取
                                if (detectionObjects.length === 0 && record.metadata) {
                                    const metadata = typeof record.metadata === 'string'
                                        ? JSON.parse(record.metadata)
                                        : record.metadata;
                                    
                                    if (metadata.objects && metadata.objects.length > 0) {
                                        detectionObjects = metadata.objects;
                                        console.log('从metadata中获取到对象数据:', detectionObjects);
                                    }
                                }
                                
                                if (detectionObjects.length > 0) {
                                    // 显示坐标容器
                                    document.getElementById('coordinatesContainer').style.display = 'block';
                                    
                                    // 获取表格体
                                    const tableBody = document.getElementById('coordinatesTableBody');
                                    tableBody.innerHTML = ''; // 清空之前的内容
                                    
                                    // 添加每个检测对象的坐标信息
                                    detectionObjects.forEach((object, index) => {
                                        // 检查是否有坐标信息
                                        if (object.x1 !== undefined && object.y1 !== undefined && 
                                            object.x2 !== undefined && object.y2 !== undefined) {
                                            
                                            // 计算宽度和高度
                                            const width = object.x2 - object.x1;
                                            const height = object.y2 - object.y1;
                                            
                                            // 获取置信度值（可能是0-1或0-100的范围）
                                            let confidence = object.confidence;
                                            // 如果置信度大于1，假设它已经是百分比形式
                                            let confidenceDisplay = confidence > 1 
                                                ? confidence.toFixed(2) + '%' 
                                                : (confidence * 100).toFixed(2) + '%';
                                            
                                            // 创建表格行
                                            const row = document.createElement('tr');
                                            row.innerHTML = `
                                                <td>${index + 1}</td>
                                                <td>${object.label || '未知类型'}</td>
                                                <td>${confidenceDisplay}</td>
                                                <td>(${Math.round(object.x1)}, ${Math.round(object.y1)})</td>
                                                <td>(${Math.round(object.x2)}, ${Math.round(object.y2)})</td>
                                                <td>${Math.round(width)} × ${Math.round(height)}</td>
                                            `;
                                            tableBody.appendChild(row);
                                        }
                                    });
                                }
                            } catch (err) {
                                console.error('解析检测结果数据时出错:', err);
                            }
                        }
                    } catch (error) {
                        console.error('处理记录详情时出错:', error);
                    }
                })
                .catch(error => {
                    console.error('加载记录详情失败:', error);
                    document.getElementById('alertDetailModalLabel').textContent = '加载失败';
                });
        }
        
        // 格式化检测类型
        function formatSourceType(sourceType) {
            switch (sourceType) {
                case 'image': return '图片检测';
                case 'video': return '视频检测';
                case 'multi_image': return '批量图片检测';
                case 'camera': return '摄像头检测';
                default: return sourceType;
            }
        }
        
        // 更新分页
        function updatePagination(currentPage, totalPages) {
            const pagination = document.getElementById('alertPagination');
            if (!pagination) return;
            
            pagination.innerHTML = '';
            
            // 如果只有一页，不显示分页
            if (totalPages <= 1) return;
            
            // 上一页
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" ${currentPage === 1 ? 'tabindex="-1" aria-disabled="true"' : ''}>上一页</a>`;
            pagination.appendChild(prevLi);
            
            // 页码
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pagination.appendChild(pageLi);
            }
            
            // 下一页
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" ${currentPage === totalPages ? 'tabindex="-1" aria-disabled="true"' : ''}>下一页</a>`;
            pagination.appendChild(nextLi);
            
            // 添加事件监听器
            const pageLinks = pagination.querySelectorAll('.page-link');
            
            pageLinks.forEach((link, index) => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    if (index === 0 && currentPage > 1) {
                        // 上一页
                        loadAlerts(currentPage - 1);
                    } else if (index === pageLinks.length - 1 && currentPage < totalPages) {
                        // 下一页
                        loadAlerts(currentPage + 1);
                    } else if (index !== 0 && index !== pageLinks.length - 1) {
                        // 页码
                        const pageNum = parseInt(this.textContent);
                        loadAlerts(pageNum);
                    }
                });
            });
        }
        
        // 创建警报统计图表
        let alertsChart;
        
        function updateChart(dailyStats) {
            const ctx = document.getElementById('alertsChart').getContext('2d');
            
            if (!dailyStats || dailyStats.length === 0) {
                if (alertsChart) {
                    alertsChart.destroy();
                    alertsChart = null;
                }
                return;
            }
            
            const labels = dailyStats.map(item => item.date);
            const data = dailyStats.map(item => item.count);
            
            if (alertsChart) {
                // 更新现有图表
                alertsChart.data.labels = labels;
                alertsChart.data.datasets[0].data = data;
                alertsChart.update();
            } else {
                // 创建新图表
                alertsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '每日垃圾检测数',
                            data: data,
                            backgroundColor: 'rgba(13, 110, 253, 0.5)',
                            borderColor: 'rgba(13, 110, 253, 0.8)',
                            borderWidth: 1,
                            borderRadius: 6,
                            hoverBackgroundColor: 'rgba(13, 110, 253, 0.7)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    color: '#6c757d'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#6c757d'
                                },
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#6c757d',
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(13, 110, 253, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                displayColors: false,
                                caretSize: 5,
                                padding: 10
                            }
                        }
                    }
                });
            }
        }
    });
</script>
{% endblock %}
