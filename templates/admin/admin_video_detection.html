{% extends "admin/admin_base.html" %}

{% block title %}视频导入识别 - 结构损伤的高级识别和绘图{% endblock %}

{% block extra_css %}
<style>
    .upload-section {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .result-section {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .instruction-section {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .upload-area {
        border: 2px dashed #d1d1d1;
        border-radius: 10px;
        padding: 50px 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: #f8f9fa;
    }
    
    .upload-area:hover {
        border-color: var(--theme-color);
        background-color: #f0f7ff;
    }
    
    .upload-icon {
        font-size: 3rem;
        color: #6c757d;
        margin-bottom: 20px;
    }
    
    .upload-text {
        color: #6c757d;
        margin-bottom: 15px;
    }
    
    .upload-formats {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .btn-detection {
        width: 100%;
        padding: 12px;
        font-weight: 500;
        font-size: 1.1rem;
    }
    
    .result-placeholder {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        height: 300px;
        color: #6c757d;
    }
    
    .result-placeholder-icon {
        font-size: 5rem;
        margin-bottom: 20px;
        color: #adb5bd;
    }
    
    .video-preview {
        width: 100%;
        max-height: 400px;
        border-radius: 8px;
        background-color: #000;
    }
    
    .progress-container {
        margin-top: 20px;
    }
    
    .video-controls {
        display: flex;
        align-items: center;
        margin-top: 15px;
        gap: 10px;
    }
    
    .video-controls .btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .video-timeline {
        flex: 1;
        height: 5px;
        background-color: #e9ecef;
        border-radius: 5px;
        position: relative;
        cursor: pointer;
        overflow: hidden;
    }
    
    .video-progress {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background-color: var(--theme-color);
        width: 0%;
    }
    
    .video-info {
        display: flex;
        justify-content: space-between;
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 8px;
    }
    
    .instruction-list {
        padding-left: 20px;
    }
    
    .instruction-list li {
        margin-bottom: 10px;
        color: #495057;
    }

    #main-content{
        margin-top: 60px;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    @media (max-width: 768px) {
        .instruction-section {
            margin-top: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- 引入侧边栏 -->
{% include "admin/admin_base_sider.html" %}

<!-- 主内容区 -->
<div class="main-with-sidebar" id="main-content">
    <div class="mt-4 px-3">
        <div class="page-header">
            <h2 class="mb-0">视频导入识别</h2>
            <button class="btn btn-outline-secondary" id="resetBtn">
                <i class="fas fa-redo me-1"></i> 重置
            </button>
        </div>
        
        <div class="row">
            <!-- 左侧上传区域 -->
            <div class="col-md-8">
                <div class="upload-section">
                    <h5 class="mb-3">视频上传</h5>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-film"></i>
                        </div>
                        <h5 class="upload-text">拖拽视频到此处或点击上传</h5>
                        <p class="upload-formats">支持MP4、AVI、MOV格式的视频</p>
                        <input type="file" id="fileInput" class="d-none" accept="video/mp4,video/avi,video/quicktime">
                    </div>
                    
                    <div class="progress-container d-none" id="uploadProgressContainer">
                        <div class="d-flex justify-content-between mb-1">
                            <span>上传进度</span>
                            <span id="uploadProgressText">0%</span>
                        </div>
                        <div class="progress">
                            <div id="uploadProgressBar" class="progress-bar position-relative" role="progressbar" style="width: 0%">
                                <span class="position-absolute w-100 text-center" style="color: #000; font-weight: 500; text-shadow: 0px 0px 2px #fff;">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-primary btn-detection" id="startDetection" disabled>
                            <i class="fas fa-search me-2"></i> 开始检测
                        </button>
                    </div>
                </div>
                
                <div class="result-section">
                    <h5 class="mb-3">检测结果</h5>
                    <div class="result-placeholder" id="resultPlaceholder">
                        <div class="result-placeholder-icon">
                            <i class="fas fa-film"></i>
                        </div>
                        <p>上传视频后将在此处显示检测结果</p>
                    </div>
                    <div id="resultContainer" class="d-none">
                        <video id="resultVideo" class="video-preview" controls>
                            您的浏览器不支持视频播放
                        </video>
                        
                        <div class="video-controls mt-3">
                            <button class="btn btn-outline-primary" id="playBtn">
                                <i class="fas fa-play"></i>
                            </button>
                            
                            <div class="video-timeline">
                                <div class="video-progress" id="videoProgress"></div>
                            </div>
                            
                            <button class="btn btn-outline-secondary" id="muteBtn">
                                <i class="fas fa-volume-up"></i>
                            </button>
                            
                            <button class="btn btn-outline-secondary" id="fullscreenBtn">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                        
                        <div class="video-info">
                            <span id="currentTime">00:00</span>
                            <span id="totalTime">00:00</span>
                        </div>
                        
                        <div class="progress-container mt-4" id="processingProgressContainer">
                            <div class="d-flex justify-content-between mb-1">
                                <span>视频处理进度</span>
                                <span id="processingProgressText">0%</span>
                            </div>
                            <div class="progress">
                                <div id="processingProgressBar" class="progress-bar position-relative" role="progressbar" style="width: 0%">
                                    <span class="position-absolute w-100 text-center" style="color: #000; font-weight: 500; text-shadow: 0px 0px 2px #fff;">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧使用说明 -->
            <div class="col-md-4">
                <div class="instruction-section">
                    <h5 class="mb-3">使用说明</h5>
                    <ol class="instruction-list">
                        <li>上传您要分析的视频（MP4、AVI或MOV格式）</li>
                        <li>点击"开始检测"按钮</li>
                        <li>系统将使用YOLOv8深度学习模型逐帧分析视频</li>
                        <li>处理过程将在右侧显示进度</li>
                    </ol>
                    
                    <div class="alert alert-info mt-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <span>视频处理时间取决于视频长度和分辨率，请耐心等待</span>
                    </div>
                    
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span>建议上传时长不超过5分钟的视频以获得最佳体验</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Socket.IO 客户端脚本 -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    // 全局变量声明 - 防止重复赋值const变量的错误
    let resultVideo, playBtn, videoProgress, videoTimeline, muteBtn, fullscreenBtn;
    let currentTime, totalTime, processingProgressContainer, processingProgressBar, processingProgressText;

    document.addEventListener('DOMContentLoaded', function() {
        // 高亮当前导航项
        highlightCurrentNavItem();
        
        // 初始化DOM元素引用
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const startDetection = document.getElementById('startDetection');
        const resultPlaceholder = document.getElementById('resultPlaceholder');
        const resultContainer = document.getElementById('resultContainer');
        resultVideo = document.getElementById('resultVideo');
        const resetBtn = document.getElementById('resetBtn');
        const uploadProgressContainer = document.getElementById('uploadProgressContainer');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const uploadProgressText = document.getElementById('uploadProgressText');
        processingProgressContainer = document.getElementById('processingProgressContainer');
        processingProgressBar = document.getElementById('processingProgressBar');
        processingProgressText = document.getElementById('processingProgressText');
        
        // 视频控制元素 - 使用let而非const以避免重新赋值错误
        playBtn = document.getElementById('playBtn');
        videoProgress = document.getElementById('videoProgress');
        videoTimeline = document.querySelector('.video-timeline');
        muteBtn = document.getElementById('muteBtn');
        fullscreenBtn = document.getElementById('fullscreenBtn');
        currentTime = document.getElementById('currentTime');
        totalTime = document.getElementById('totalTime');
        
        // 点击上传区域触发文件选择
        uploadArea.addEventListener('click', function() {
            fileInput.click();
        });
        
        // 拖拽文件功能
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('border-primary');
        });
        
        uploadArea.addEventListener('dragleave', function() {
            uploadArea.classList.remove('border-primary');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('border-primary');
            
            if (e.dataTransfer.files.length) {
                handleFileUpload(e.dataTransfer.files[0]);
            }
        });
        
        // 文件选择变化
        fileInput.addEventListener('change', function() {
            if (fileInput.files.length) {
                handleFileUpload(fileInput.files[0]);
            }
        });
        
        // 处理文件上传
        function handleFileUpload(file) {
            if (!file.type.match('video.*')) {
                alert('请上传有效的视频文件（MP4、AVI或MOV格式）');
                return;
            }
            
            // 显示上传进度
            uploadProgressContainer.classList.remove('d-none');
            uploadProgressText.textContent = '0%';
            uploadProgressBar.style.width = '0%';
            
            // 更新上传区域样式
            uploadArea.querySelector('.upload-text').textContent = file.name;
            uploadArea.querySelector('.upload-formats').textContent = `${(file.size / (1024 * 1024)).toFixed(2)} MB · ${file.type.split('/')[1].toUpperCase()}`;
            
            // 模拟上传进度
            let progress = 0;
            const uploadInterval = setInterval(function() {
                progress += 5;
                uploadProgressBar.style.width = `${progress}%`;
                uploadProgressBar.innerHTML = `<span class="position-absolute w-100 text-center" style="color: #000; font-weight: 500; text-shadow: 0px 0px 2px #fff;">${progress}%</span>`;
                uploadProgressText.textContent = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(uploadInterval);
                    
                    // 启用检测按钮
                    startDetection.disabled = false;
                    
                    // 创建视频URL并预览
                    const videoURL = URL.createObjectURL(file);
                    resultVideo.src = videoURL;
                    
                    // 加载视频元数据
                    resultVideo.addEventListener('loadedmetadata', function() {
                        // 更新视频时长
                        totalTime.textContent = formatTime(resultVideo.duration);
                    });
                }
            }, 100);
        }
        
        // 开始检测按钮点击事件
        startDetection.addEventListener('click', function() {
            // 检查是否有视频文件
            if (!fileInput.files[0]) {
                alert('请先上传视频文件');
                return;
            }
            
            // 显示结果区域
            resultPlaceholder.classList.add('d-none');
            resultContainer.classList.remove('d-none');
            
            // 禁用开始检测按钮
            startDetection.disabled = true;
            startDetection.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> 处理中...';
            
            // 显示处理进度
            processingProgressContainer.classList.remove('d-none');
            processingProgressBar.style.width = '0%';
            processingProgressText.textContent = '0%';
            
            // 创建FormData对象
            const formData = new FormData();
            formData.append('video', fileInput.files[0]);
            
            // WebSocket连接用于接收进度更新
            const socket = io();
            
            // 通过WebSocket接收进度更新
            socket.on('detection_progress', function(data) {
                const progress = data.progress;
                
                // 更新处理进度条样式，添加内部文本显示
                processingProgressBar.style.width = `${progress}%`;
                processingProgressBar.innerHTML = `<span class="position-absolute w-100 text-center" style="color: #000; font-weight: 500; text-shadow: 0px 0px 2px #fff;">${progress}%</span>`;
                processingProgressText.textContent = `${progress}% (${data.current_frame}/${data.total_frames} 帧)`;
            });
            
            // 发送视频进行检测
            fetch('/api/detect/video', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log("检测API返回数据:", data);
                
                // 更新按钮状态
                startDetection.innerHTML = '<i class="fas fa-check me-2"></i> 处理完成';
                processingProgressBar.style.width = '100%';
                processingProgressBar.innerHTML = '<span class="position-absolute w-100 text-center" style="color: #000; font-weight: 500; text-shadow: 0px 0px 2px #fff;">100%</span>';
                processingProgressText.textContent = '100% (完成)';
                
                if (data.success) {
                    // 获取视频URL并确保有正确的路径
                    // 适配不同的API响应格式：优先使用result_video_url，其次是result_url
                    let videoUrl = data.result_video_url || data.result_url;
                    if (videoUrl && !videoUrl.startsWith('http')) {
                        videoUrl = window.location.origin + videoUrl;
                    }
                    
                    // 如果没有有效的视频URL，显示错误消息
                    if (!videoUrl) {
                        console.error('没有获取到视频URL:', data);
                        resultContainer.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                无法加载视频结果，请重试或联系管理员
                            </div>
                        `;
                        
                        // 显示检测结果统计（如果有）
                        showDetectionResults(data);
                        return;
                    }
                    
                    // 确定视频格式
                    const isAvi = videoUrl.toLowerCase().endsWith('.avi');
                    const videoType = isAvi ? 'video/x-msvideo' : 'video/mp4';
                    
                    // 获取处理时间，确保有默认值
                    const processingTime = data.processing_time || 
                                     data.detection_results?.processing_time || 
                                     data.duration || 0;
                    
                    // 直接使用HTML5标准方式播放视频
                    resultContainer.innerHTML = `
                        <div class="mb-4">
                            <video controls class="video-preview" id="resultVideo">
                                <source src="${videoUrl}" type="${videoType}">
                                您的浏览器不支持视频播放
                            </video>
                        </div>
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>视频处理完成，耗时：${processingTime.toFixed(2)}秒
                            <a href="${videoUrl}" download class="btn btn-sm btn-primary float-end">
                                <i class="fas fa-download me-1"></i>下载结果
                            </a>
                        </div>
                    `;
                    
                    // 添加备选播放选项，确保在所有环境下都能播放
                    if (isAvi) {
                        const backupPlayer = document.createElement('div');
                        backupPlayer.className = 'alert alert-info mt-3';
                        backupPlayer.innerHTML = `
                            <p><i class="fas fa-info-circle me-2"></i>
                            如果视频无法直接播放，请尝试 
                            <a href="${videoUrl}" download class="alert-link">下载后观看</a>
                            </p>
                        `;
                        resultContainer.appendChild(backupPlayer);
                    }
                    
                    // 获取新的视频元素
                    resultVideo = document.getElementById('resultVideo');
                    
                    // 显示检测结果统计
                    showDetectionResults(data);
                    
                    // 定义在视频元数据加载后触发的事件
                    resultVideo.addEventListener('loadedmetadata', function() {
                        totalTime.textContent = formatTime(this.duration);
                    });
                    
                    // 添加错误处理
                    resultVideo.addEventListener('error', function(e) {
                        console.error('视频加载错误:', this.error);
                        const errorMsg = document.createElement('div');
                        errorMsg.className = 'alert alert-danger mt-3';
                        errorMsg.innerHTML = `
                            <i class="fas fa-exclamation-circle me-2"></i>
                            视频播放失败，您可以尝试 
                            <a href="${videoUrl}" download class="alert-link">下载后观看</a>
                        `;
                        
                        // 确保错误消息只添加一次
                        if (!document.querySelector('.alert-danger')) {
                            resultContainer.appendChild(errorMsg);
                        }
                    });
                } else {
                    // 处理失败情况
                    resultContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            视频处理失败: ${data.error || '未知错误'}
                        </div>
                    `;
                    console.error('视频处理失败:', data.error);
                }
                
                // 延迟后重新启用按钮
                setTimeout(() => {
                    startDetection.disabled = false;
                    startDetection.innerHTML = '<i class="fas fa-search me-2"></i> 重新检测';
                }, 1000);
            })
            .catch(error => {
                console.error('请求错误:', error);
                startDetection.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i> 处理失败';
                
                resultContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        处理请求失败，请重试
                    </div>
                `;
                
                setTimeout(() => {
                    startDetection.disabled = false;
                    startDetection.innerHTML = '<i class="fas fa-search me-2"></i> 重新检测';
                }, 1000);
            });
        });
        
        // 播放/暂停按钮
        playBtn.addEventListener('click', function() {
            if (resultVideo.paused) {
                resultVideo.play();
                playBtn.querySelector('i').className = 'fas fa-pause';
            } else {
                resultVideo.pause();
                playBtn.querySelector('i').className = 'fas fa-play';
            }
        });
        
        // 视频播放事件
        resultVideo.addEventListener('play', function() {
            playBtn.querySelector('i').className = 'fas fa-pause';
        });
        
        // 视频暂停事件
        resultVideo.addEventListener('pause', function() {
            playBtn.querySelector('i').className = 'fas fa-play';
        });
        
        // 视频结束事件
        resultVideo.addEventListener('ended', function() {
            playBtn.querySelector('i').className = 'fas fa-play';
        });
        
        // 更新进度条和时间
        resultVideo.addEventListener('timeupdate', function() {
            const percent = (resultVideo.currentTime / resultVideo.duration) * 100;
            videoProgress.style.width = `${percent}%`;
            currentTime.textContent = formatTime(resultVideo.currentTime);
        });
        
        // 点击进度条跳转
        videoTimeline.addEventListener('click', function(e) {
            const timelineWidth = this.clientWidth;
            const clickX = e.offsetX;
            const duration = resultVideo.duration;
            
            resultVideo.currentTime = (clickX / timelineWidth) * duration;
        });
        
        // 静音按钮
        muteBtn.addEventListener('click', function() {
            resultVideo.muted = !resultVideo.muted;
            if (resultVideo.muted) {
                muteBtn.querySelector('i').className = 'fas fa-volume-mute';
            } else {
                muteBtn.querySelector('i').className = 'fas fa-volume-up';
            }
        });
        
        // 全屏按钮
        fullscreenBtn.addEventListener('click', function() {
            if (!document.fullscreenElement) {
                if (resultVideo.requestFullscreen) {
                    resultVideo.requestFullscreen();
                } else if (resultVideo.webkitRequestFullscreen) {
                    resultVideo.webkitRequestFullscreen();
                } else if (resultVideo.msRequestFullscreen) {
                    resultVideo.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        });
        
        // 重置按钮功能
        resetBtn.addEventListener('click', function() {
            // 重置所有状态
            fileInput.value = '';
            resultPlaceholder.classList.remove('d-none');
            resultContainer.classList.add('d-none');
            resultContainer.innerHTML = `
                <video id="resultVideo" class="video-preview" controls>
                    您的浏览器不支持视频播放
                </video>
                
                <div class="video-controls mt-3">
                    <button class="btn btn-outline-primary" id="playBtn">
                        <i class="fas fa-play"></i>
                    </button>
                    
                    <div class="video-timeline">
                        <div class="video-progress" id="videoProgress"></div>
                    </div>
                    
                    <button class="btn btn-outline-secondary" id="muteBtn">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    
                    <button class="btn btn-outline-secondary" id="fullscreenBtn">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
                
                <div class="video-info">
                    <span id="currentTime">00:00</span>
                    <span id="totalTime">00:00</span>
                </div>
                
                <div class="progress-container mt-4" id="processingProgressContainer">
                    <div class="d-flex justify-content-between mb-1">
                        <span>视频处理进度</span>
                        <span id="processingProgressText">0%</span>
                    </div>
                    <div class="progress">
                        <div id="processingProgressBar" class="progress-bar position-relative" role="progressbar" style="width: 0%">
                            <span class="position-absolute w-100 text-center" style="color: #000; font-weight: 500; text-shadow: 0px 0px 2px #fff;">0%</span>
                        </div>
                    </div>
                </div>
            `;
            
            // 重新获取视频控制元素 - 修复常量赋值错误
            resultVideo = document.getElementById('resultVideo');
            
            // 注意：不要尝试重新分配const变量，而是使用let声明的变量
            playBtn = document.getElementById('playBtn');
            videoProgress = document.getElementById('videoProgress');
            muteBtn = document.getElementById('muteBtn');
            fullscreenBtn = document.getElementById('fullscreenBtn');
            currentTime = document.getElementById('currentTime');
            totalTime = document.getElementById('totalTime');
            processingProgressBar = document.getElementById('processingProgressBar');
            processingProgressText = document.getElementById('processingProgressText');
            
            uploadProgressContainer.classList.add('d-none');
            // 重置上传进度条
            uploadProgressBar.style.width = '0%';
            uploadProgressBar.innerHTML = '<span class="position-absolute w-100 text-center" style="color: #000; font-weight: 500; text-shadow: 0px 0px 2px #fff;">0%</span>';
            uploadProgressText.textContent = '0%';
            
            processingProgressContainer = document.getElementById('processingProgressContainer');
            processingProgressContainer.classList.add('d-none');
            startDetection.disabled = true;
            startDetection.innerHTML = '<i class="fas fa-search me-2"></i> 开始检测';
            
            // 重置上传区域
            uploadArea.querySelector('.upload-text').textContent = '拖拽视频到此处或点击上传';
            uploadArea.querySelector('.upload-formats').textContent = '支持MP4、AVI、MOV格式的视频';
            
            // 清除任何创建的检测结果容器
            const detectionResultsContainer = document.getElementById('detectionResultsContainer');
            if (detectionResultsContainer) {
                detectionResultsContainer.remove();
            }
        });
        
        // 格式化时间为 mm:ss 格式
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // 高亮当前导航项函数
        function highlightCurrentNavItem() {
            // 移除所有导航项的激活状态
            const navItems = document.querySelectorAll('.sidebar-menu .nav-link');
            navItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // 获取视频导入识别导航项并添加激活状态
            const videoNavItem = document.querySelector('.sidebar-menu .nav-link[href*="video_detection"]');
            if (videoNavItem) {
                videoNavItem.classList.add('active');
            }
        }
        
        // 显示检测结果统计信息
        function showDetectionResults(data) {
            console.log("处理检测结果:", data);
            // 创建或获取检测结果容器
            let resultsContainer = document.getElementById('detectionResultsContainer');
            if (!resultsContainer) {
                resultsContainer = document.createElement('div');
                resultsContainer.id = 'detectionResultsContainer';
                resultsContainer.className = 'mt-4';
                
                // 添加到结果容器后
                resultContainer.appendChild(resultsContainer);
            }
            
            // 清空容器
            resultsContainer.innerHTML = '';
            
            // 创建标题
            const title = document.createElement('h5');
            title.className = 'mb-3';
            title.textContent = '检测统计';
            resultsContainer.appendChild(title);
            
            // 如果没有检测结果数据，显示提示并返回
            if (!data) {
                console.warn("没有检测结果数据:", data);
                const noResults = document.createElement('div');
                noResults.className = 'alert alert-info';
                noResults.textContent = '没有获取到检测结果数据';
                resultsContainer.appendChild(noResults);
                return;
            }
            
            // 适配新的API响应格式
            let detectionResults = null;
            let objectsList = [];
            let avgConfidence = 0;
            
            // 检查新的直接返回格式（含object_distribution）
            if (data.object_distribution && typeof data.object_distribution === 'object') {
                detectionResults = data.object_distribution;
                avgConfidence = data.avg_confidence || 0;
                console.log("找到object_distribution:", detectionResults);
            }
            // 检查是否有detection_results
            else if (data.detection_results) {
                // 检查是否有新格式的summary字段
                if (data.detection_results.summary) {
                    detectionResults = data.detection_results.summary;
                    console.log("找到检测结果summary:", detectionResults);
                } 
                // 检查对象列表
                else if (data.detection_results.objects && Array.isArray(data.detection_results.objects)) {
                    objectsList = data.detection_results.objects;
                    console.log("找到对象列表:", objectsList);
                    
                    // 从对象列表生成统计数据
                    detectionResults = {};
                    objectsList.forEach(obj => {
                        const label = obj.label || '未知';
                        if (!detectionResults[label]) {
                            detectionResults[label] = 0;
                        }
                        detectionResults[label]++;
                    });
                }
                // 检查是否是旧格式（直接是对象或包含objects_detected）
                else if (typeof data.detection_results === 'object') {
                    if (data.detection_results.objects_detected !== undefined) {
                        // 创建简单统计
                        detectionResults = { '检测对象': data.detection_results.objects_detected };
                    } else {
                        // 尝试使用整个对象
                        detectionResults = data.detection_results;
                    }
                    console.log("找到旧格式的检测结果:", detectionResults);
                }
            }
            
            // 处理统计信息
            if (detectionResults && Object.keys(detectionResults).length > 0) {
                // 创建卡片
                const card = document.createElement('div');
                card.className = 'card';
                
                // 卡片内容
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';
                
                // 如果有置信度信息，显示在顶部
                if (avgConfidence > 0) {
                    const confidenceInfo = document.createElement('div');
                    confidenceInfo.className = 'alert alert-info mb-3';
                    confidenceInfo.innerHTML = `
                        <i class="fas fa-info-circle me-2"></i>
                        平均置信度: <strong>${avgConfidence.toFixed(2)}%</strong>
                    `;
                    cardBody.appendChild(confidenceInfo);
                }
                
                // 创建结果表格
                const table = document.createElement('table');
                table.className = 'table table-striped table-sm';
                
                // 表头
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>检测对象</th>
                        <th>数量</th>
                        <th>占比</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                // 表体
                const tbody = document.createElement('tbody');
                
                // 计算总数
                let totalObjects = 0;
                for (const [key, value] of Object.entries(detectionResults)) {
                    totalObjects += value;
                }
                
                // 检查是否与返回的total_objects一致
                if (data.total_objects && data.total_objects !== totalObjects) {
                    console.warn(`总对象数不匹配：计算得 ${totalObjects}，API返回 ${data.total_objects}`);
                    // 使用API返回的总数
                    totalObjects = data.total_objects;
                }
                
                // 添加每行数据
                for (const [objectName, count] of Object.entries(detectionResults)) {
                    const percentage = ((count / totalObjects) * 100).toFixed(1);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${objectName}</td>
                        <td>${count}</td>
                        <td>
                            <div class="progress" style="height: 15px;">
                                <div class="progress-bar position-relative" role="progressbar" style="width: ${percentage}%">
                                    <span class="position-absolute w-100 text-center" style="color: #000; font-weight: 500; text-shadow: 0px 0px 2px #fff;">${percentage}%</span>
                                </div>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
                
                // 添加总计行
                const totalRow = document.createElement('tr');
                totalRow.className = 'table-dark';
                totalRow.innerHTML = `
                    <td><strong>总计</strong></td>
                    <td><strong>${totalObjects}</strong></td>
                    <td><strong>100%</strong></td>
                `;
                tbody.appendChild(totalRow);
                
                table.appendChild(tbody);
                cardBody.appendChild(table);
                card.appendChild(cardBody);
                resultsContainer.appendChild(card);
                
                // 如果有对象详情数据，添加对象详情部分
                if (objectsList.length > 0 || 
                    (data.detection_results?.objects && 
                     Array.isArray(data.detection_results.objects) && 
                     data.detection_results.objects.length > 0)) {
                    
                    // 确保使用正确的对象列表
                    if (objectsList.length === 0 && data.detection_results?.objects) {
                        objectsList = data.detection_results.objects;
                    }
                    
                    // 在原有统计后面添加对象详情
                    const detailsTitle = document.createElement('h5');
                    detailsTitle.className = 'mb-3 mt-4';
                    detailsTitle.textContent = '对象详情';
                    resultsContainer.appendChild(detailsTitle);
                    
                    // 创建折叠容器，默认折叠
                    const detailsCard = document.createElement('div');
                    detailsCard.className = 'card';
                    
                    const detailsHeader = document.createElement('div');
                    detailsHeader.className = 'card-header d-flex justify-content-between align-items-center';
                    detailsHeader.innerHTML = `
                        <span>共检测到 ${objectsList.length} 个对象</span>
                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#objectDetails" aria-expanded="false" aria-controls="objectDetails">
                            查看详情
                        </button>
                    `;
                    
                    const detailsCollapse = document.createElement('div');
                    detailsCollapse.className = 'collapse';
                    detailsCollapse.id = 'objectDetails';
                    
                    const detailsBody = document.createElement('div');
                    detailsBody.className = 'card-body';
                    
                    // 创建表格显示对象详情
                    const detailsTable = document.createElement('table');
                    detailsTable.className = 'table table-sm table-hover';
                    
                    // 表头
                    const detailsThead = document.createElement('thead');
                    detailsThead.innerHTML = `
                        <tr>
                            <th>#</th>
                            <th>类型</th>
                            <th>置信度</th>
                            <th>坐标</th>
                            <th>尺寸</th>
                        </tr>
                    `;
                    
                    // 表体
                    const detailsTbody = document.createElement('tbody');
                    
                    // 最多显示50个，避免页面过长
                    const maxObjects = Math.min(objectsList.length, 50);
                    
                    for (let i = 0; i < maxObjects; i++) {
                        const obj = objectsList[i];
                        // 确认坐标存在
                        if (obj && obj.x1 !== undefined && obj.y1 !== undefined && 
                            obj.x2 !== undefined && obj.y2 !== undefined) {
                            
                            // 计算尺寸
                            const width = obj.x2 - obj.x1;
                            const height = obj.y2 - obj.y1;
                            
                            const objRow = document.createElement('tr');
                            objRow.innerHTML = `
                                <td>${i + 1}</td>
                                <td>${obj.label || '未知'}</td>
                                <td>${obj.confidence ? obj.confidence.toFixed(1) + '%' : '-'}</td>
                                <td>(${obj.x1},${obj.y1})-(${obj.x2},${obj.y2})</td>
                                <td>${width}×${height}px</td>
                            `;
                            detailsTbody.appendChild(objRow);
                        }
                    }
                    
                    // 如果对象太多，显示"还有更多"的提示
                    if (objectsList.length > 50) {
                        const moreRow = document.createElement('tr');
                        moreRow.className = 'table-secondary';
                        moreRow.innerHTML = `
                            <td colspan="5" class="text-center">
                                还有 ${objectsList.length - 50} 个对象未显示
                            </td>
                        `;
                        detailsTbody.appendChild(moreRow);
                    }
                    
                    detailsTable.appendChild(detailsThead);
                    detailsTable.appendChild(detailsTbody);
                    detailsBody.appendChild(detailsTable);
                    detailsCollapse.appendChild(detailsBody);
                    
                    detailsCard.appendChild(detailsHeader);
                    detailsCard.appendChild(detailsCollapse);
                    
                    resultsContainer.appendChild(detailsCard);
                }
                
                // 添加处理时间信息（如果有）
                if (data.processing_time) {
                    const timeInfo = document.createElement('div');
                    timeInfo.className = 'alert alert-light mt-3';
                    timeInfo.innerHTML = `
                        <i class="fas fa-clock me-2"></i>
                        处理耗时: <strong>${data.processing_time.toFixed(2)}秒</strong>
                    `;
                    resultsContainer.appendChild(timeInfo);
                }
            } else {
                // 如果有total_objects但没有详细分布，创建一个简单的显示
                if (data.total_objects && data.total_objects > 0) {
                    const simpleResult = document.createElement('div');
                    simpleResult.className = 'alert alert-success';
                    simpleResult.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        共检测到 <strong>${data.total_objects}</strong> 个对象
                    `;
                    resultsContainer.appendChild(simpleResult);
                    
                    // 添加处理时间（如果有）
                    if (data.processing_time) {
                        const timeInfo = document.createElement('div');
                        timeInfo.className = 'alert alert-light mt-3';
                        timeInfo.innerHTML = `
                            <i class="fas fa-clock me-2"></i>
                            处理耗时: <strong>${data.processing_time.toFixed(2)}秒</strong>
                        `;
                        resultsContainer.appendChild(timeInfo);
                    }
                } else {
                    console.warn("未找到有效的检测结果数据:", data);
                    // 无结果情况
                    const noResults = document.createElement('div');
                    noResults.className = 'alert alert-info';
                    noResults.textContent = '没有检测到任何对象';
                    resultsContainer.appendChild(noResults);
                }
            }
        }
    });
</script>
{% endblock %}