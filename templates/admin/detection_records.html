{% extends "admin/admin_base.html" %}

{% block title %}检测记录 - 结构损伤的高级识别和绘图{% endblock %}

{% block extra_css %}
<style>
    .table-card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        background-color: #fff;
    }
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .filter-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 10px 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
    }
    .filter-group {
        display: flex;
        gap: 10px;
    }
    .status-badge {
        width: 100px;
        text-align: center;
    }
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    .pagination-wrapper {
        display: flex;
        justify-content: flex-end;
        margin-top: 20px;
    }
    /* 预览模态框样式 */
    .preview-modal {
        display: none;
        position: fixed;
        z-index: 1050;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
    }
    .preview-content {
        position: relative;
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border-radius: 10px;
        width: 80%;
        max-width: 900px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .close-button {
        position: absolute;
        top: 15px;
        right: 20px;
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .close-button:hover {
        color: #555;
    }
    .media-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
    }
    .media-container {
        flex: 1;
        min-width: 300px;
        max-width: 48%;
    }
    .media-container img, 
    .media-container video {
        max-width: 100%;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
    .detection-details {
        margin-top: 20px;
    }
    .object-list {
        margin-top: 10px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 5px;
        padding: 10px;
    }
    .object-item {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        border-bottom: 1px solid #f5f5f5;
    }
    .object-item:last-child {
        border-bottom: none;
    }
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 20px;
    }
    .empty-records {
        text-align: center;
        padding: 30px;
        color: #6c757d;
    }
    .video-container {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 56.25%; /* 16:9 比例 */
        overflow: hidden;
        border-radius: 5px;
    }
    .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        background-color: #000;
    }
    .video-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 200px;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
    .media-tabs {
        display: flex;
        margin-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
    }
    .media-tab {
        padding: 8px 15px;
        margin-right: 5px;
        border: 1px solid transparent;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
        cursor: pointer;
    }
    .media-tab.active {
        color: #495057;
        background-color: #fff;
        border-color: #dee2e6 #dee2e6 #fff;
    }
    .media-content {
        display: none;
    }
    .media-content.active {
        display: block;
    }
    
    /* 垃圾坐标表格样式 */
    #coordinatesSection {
        margin-top: 20px;
        border-top: 1px solid #eee;
        padding-top: 15px;
    }
    
    #coordinatesTableBody tr:hover {
        background-color: #f8f9fa;
    }
    
    #coordinatesTableBody td {
        vertical-align: middle;
        padding: 6px 8px;
    }
    
    /* 修复内容被header遮盖的问题 */
    #main-content {
        margin-top: 60px;
    }
</style>
{% endblock %}

{% block content %}
<!-- 引入侧边栏 -->
{% include "admin/admin_base_sider.html" %}

<!-- 主内容区 -->
<div class="main-with-sidebar" id="main-content">
    <div class="mt-4 px-3">
        <!-- 页头 -->
        <div class="page-header">
            <h2 class="mb-0">最近检测记录</h2>
            <div>
                <button id="exportBtn" class="btn btn-sm btn-outline-primary me-2">
                    <i class="fas fa-download me-1"></i> 导出数据
                </button>
                <button id="refreshBtn" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-sync-alt me-1"></i> 刷新
                </button>
            </div>
        </div>
        
        <!-- 筛选栏 -->
        <div class="filter-bar">
            <div class="filter-group">
                <select id="sourceTypeFilter" class="form-select form-select-sm">
                    <option value="">所有类型</option>
                    <option value="image">单张图片</option>
                    <option value="multi_image">批量图片</option>
                    <option value="video">视频</option>
                    <option value="camera">实时检测</option>
                </select>
                <select id="resultFilter" class="form-select form-select-sm">
                    <option value="">所有结果</option>
                    <option value="true">检测到垃圾</option>
                    <option value="false">未检测到垃圾</option>
                </select>
                <button id="applyFilter" class="btn btn-sm btn-primary">
                    <i class="fas fa-filter me-1"></i> 筛选
                </button>
            </div>
            <div class="search-box">
                <div class="input-group">
                    <input id="searchInput" type="text" class="form-control form-control-sm" placeholder="搜索文件名...">
                    <button id="searchBtn" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 数据表格 -->
        <div class="table-card">
            <div class="loading-spinner" id="loadingSpinner" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">加载数据中...</p>
            </div>
            
            <div class="empty-records" id="emptyRecords" style="display: none;">
                <i class="fas fa-file-alt fa-3x mb-3"></i>
                <h5>暂无检测记录</h5>
                <p>当前筛选条件下没有找到任何检测记录</p>
            </div>
            
            <div class="table-responsive" id="recordsTable">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>检测类型</th>
                            <th>来源</th>
                            <th>结果</th>
                            <th>时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody">
                        <!-- 数据动态加载 -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 分页控件 -->
        <div class="pagination-wrapper">
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm" id="pagination">
                    <!-- 分页将动态生成 -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- 预览模态框 -->
<div id="previewModal" class="preview-modal">
    <div class="preview-content">
        <span class="close-button" id="closePreview">&times;</span>
        <h4 id="previewTitle">检测记录详情</h4>
        
        <div class="media-tabs" id="mediaTabs">
            <div class="media-tab active" data-tab="originalMedia">原始媒体</div>
            <div class="media-tab" data-tab="resultMedia">检测结果</div>
        </div>
        
        <div class="media-content active" id="originalMedia">
            <!-- 图片预览 -->
            <div id="imagePreview" style="display: none;">
                <img id="originalImage" src="" alt="原始图像" class="img-fluid">
            </div>
            
            <!-- 视频预览 -->
            <div id="videoPreview" style="display: none;">
                <div class="video-container">
                    <video id="originalVideo" controls>
                        <!-- source will be added dynamically -->
                        您的浏览器不支持视频播放
                    </video>
                </div>
            </div>
            
            <!-- 无媒体占位符 -->
            <div id="noMediaPlaceholder" class="video-placeholder">
                <i class="fas fa-file-image fa-3x mb-2"></i>
                <p>无可预览的媒体文件</p>
            </div>
        </div>
        
        <div class="media-content" id="resultMedia">
            <!-- 检测结果图片预览 -->
            <div id="resultImagePreview" style="display: none;">
                <img id="resultImage" src="" alt="检测结果" class="img-fluid">
            </div>
            
            <!-- 检测结果视频预览 -->
            <div id="resultVideoPreview" style="display: none;">
                <div class="video-container">
                    <video id="resultVideo" controls>
                        <!-- source will be added dynamically -->
                        您的浏览器不支持视频播放
                    </video>
                </div>
            </div>
            
            <!-- 无结果占位符 -->
            <div id="noResultPlaceholder" class="video-placeholder">
                <i class="fas fa-exclamation-circle fa-3x mb-2"></i>
                <p>无可用的检测结果</p>
            </div>
        </div>
        
        <div class="detection-details">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>ID:</strong> <span id="detailId"></span></p>
                    <p><strong>检测类型:</strong> <span id="detailType"></span></p>
                    <p><strong>文件名:</strong> <span id="detailFilename"></span></p>
                    <p><strong>时间:</strong> <span id="detailTime"></span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>用户:</strong> <span id="detailUser"></span></p>
                    <p><strong>检测耗时:</strong> <span id="detailDuration"></span>秒</p>
                    <p><strong>检测到对象数:</strong> <span id="detailObjects"></span></p>
                    <p><strong>清理状态:</strong> <span id="detailCleaned"></span></p>
                </div>
            </div>
            
            <div id="objectsSection">
                <h6>检测到的对象:</h6>
                <div class="object-list" id="objectList">
                    <!-- 对象列表将在这里动态加载 -->
                </div>
            </div>
            
            <!-- 新增：垃圾坐标信息 -->
            <div id="coordinatesSection" style="display: none;">
                <h6 class="mt-4 border-bottom pb-2">检测到的垃圾坐标信息</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>垃圾类型</th>
                                <th>置信度</th>
                                <th>坐标 (左上角)</th>
                                <th>坐标 (右下角)</th>
                                <th>尺寸 (宽×高)</th>
                            </tr>
                        </thead>
                        <tbody id="coordinatesTableBody">
                            <!-- 坐标数据将通过JavaScript动态添加 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化变量
        let currentPage = 1;
        let recordsPerPage = 10;
        let totalPages = 1;
        
        // DOM元素
        const loadingSpinner = document.getElementById('loadingSpinner');
        const emptyRecords = document.getElementById('emptyRecords');
        const recordsTable = document.getElementById('recordsTable');
        const recordsTableBody = document.getElementById('recordsTableBody');
        const pagination = document.getElementById('pagination');
        
        // 筛选元素
        const sourceTypeFilter = document.getElementById('sourceTypeFilter');
        const resultFilter = document.getElementById('resultFilter');
        const searchInput = document.getElementById('searchInput');
        const applyFilter = document.getElementById('applyFilter');
        const searchBtn = document.getElementById('searchBtn');
        
        // 按钮元素
        const refreshBtn = document.getElementById('refreshBtn');
        const exportBtn = document.getElementById('exportBtn');
        
        // 模态框元素
        const previewModal = document.getElementById('previewModal');
        const closePreview = document.getElementById('closePreview');
        const mediaTabs = document.getElementById('mediaTabs');
        
        // 媒体预览元素
        const originalMedia = document.getElementById('originalMedia');
        const resultMedia = document.getElementById('resultMedia');
        const imagePreview = document.getElementById('imagePreview');
        const videoPreview = document.getElementById('videoPreview');
        const noMediaPlaceholder = document.getElementById('noMediaPlaceholder');
        const resultImagePreview = document.getElementById('resultImagePreview');
        const resultVideoPreview = document.getElementById('resultVideoPreview');
        const noResultPlaceholder = document.getElementById('noResultPlaceholder');
        
        // 图片和视频元素
        let originalImage = document.getElementById('originalImage');
        let resultImage = document.getElementById('resultImage');
        let originalVideo = document.getElementById('originalVideo');
        let resultVideo = document.getElementById('resultVideo');
        
        // 保存视频容器引用
        const originalVideoContainer = videoPreview.querySelector('.video-container');
        const resultVideoContainer = resultVideoPreview.querySelector('.video-container');
        
        // 媒体标签切换
        document.querySelectorAll('.media-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // 移除所有标签的active类
                document.querySelectorAll('.media-tab').forEach(t => {
                    t.classList.remove('active');
                });
                // 给当前标签添加active类
                this.classList.add('active');
                
                // 隐藏所有内容
                document.querySelectorAll('.media-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // 显示对应的内容
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // 加载记录
        loadRecords(1);
        
        // 刷新按钮点击事件
        refreshBtn.addEventListener('click', function() {
            loadRecords(currentPage);
        });
        
        // 导出按钮点击事件
        exportBtn.addEventListener('click', function() {
            exportRecords();
        });
        
        // 筛选按钮点击事件
        applyFilter.addEventListener('click', function() {
            currentPage = 1;  // 重置页码
            loadRecords(currentPage);
        });
        
        // 搜索按钮点击事件
        searchBtn.addEventListener('click', function() {
            currentPage = 1;  // 重置页码
            loadRecords(currentPage);
        });
        
        // 回车键搜索
        searchInput.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                currentPage = 1;
                loadRecords(currentPage);
            }
        });
        
        // 关闭预览模态框
        closePreview.addEventListener('click', function() {
            previewModal.style.display = 'none';
            // 暂停所有视频
            pauseAllVideos();
        });
        
        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            if (event.target == previewModal) {
                previewModal.style.display = 'none';
                // 暂停所有视频
                pauseAllVideos();
            }
        });
        
        // 暂停所有视频
        function pauseAllVideos() {
            const videos = document.querySelectorAll('video');
            videos.forEach(video => {
                if (!video.paused) {
                    video.pause();
                }
            });
        }
        
        // 加载记录函数
        function loadRecords(page) {
            // 显示加载中
            loadingSpinner.style.display = 'block';
            recordsTable.style.display = 'none';
            emptyRecords.style.display = 'none';
            
            // 获取筛选参数
            const sourceType = sourceTypeFilter.value;
            const hasObjects = resultFilter.value;
            const search = searchInput.value.trim();
            
            // 构建API URL
            let url = `/api/detection_records?page=${page}&per_page=${recordsPerPage}`;
            if (sourceType) url += `&source_type=${sourceType}`;
            if (hasObjects) url += `&has_objects=${hasObjects}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            
            // 请求数据
            fetch(url)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const data = result.data;
                        
                        // 更新当前页和总页数
                        currentPage = data.pagination.page;
                        totalPages = data.pagination.total_pages;
                        
                        // 渲染记录
                        renderRecords(data.records);
                        // 渲染分页
                        renderPagination(data.pagination);
                        
                        // 如果没有记录，显示空状态
                        if (data.records.length === 0) {
                            emptyRecords.style.display = 'block';
                            recordsTable.style.display = 'none';
                        } else {
                            emptyRecords.style.display = 'none';
                            recordsTable.style.display = 'block';
                        }
                    } else {
                        console.error('获取记录失败:', result.message);
                        alert('获取记录失败: ' + result.message);
                    }
                })
                .catch(error => {
                    console.error('API请求错误:', error);
                    alert('API请求错误: ' + error);
                })
                .finally(() => {
                    // 隐藏加载中
                    loadingSpinner.style.display = 'none';
                });
        }
        
        // 渲染记录函数
        function renderRecords(records) {
            recordsTableBody.innerHTML = '';
            
            records.forEach((record, index) => {
                // 创建行
                const row = document.createElement('tr');
                
                // 创建检测类型标签
                let sourceTypeBadge = '';
                switch(record.source_type) {
                    case 'image':
                        sourceTypeBadge = '<span class="badge bg-primary">单张图片</span>';
                        break;
                    case 'multi_image':
                        sourceTypeBadge = '<span class="badge bg-success">批量图片</span>';
                        break;
                    case 'video':
                        sourceTypeBadge = '<span class="badge bg-warning">视频</span>';
                        break;
                    case 'camera':
                        sourceTypeBadge = '<span class="badge bg-info">实时检测</span>';
                        break;
                    default:
                        sourceTypeBadge = '<span class="badge bg-secondary">其他</span>';
                }
                
                // 创建检测结果标签
                const resultBadge = record.has_objects
                    ? '<span class="badge bg-danger">检测到垃圾</span>'
                    : '<span class="badge bg-success">未检测到垃圾</span>';
                
                // 源文件名，如果太长则截断
                const sourceName = record.source_name 
                    ? (record.source_name.length > 30 ? record.source_name.substring(0, 30) + '...' : record.source_name)
                    : '无文件名';
                
                // 计算序号：(当前页码-1) * 每页记录数 + 当前索引 + 1
                const sequentialId = (currentPage - 1) * recordsPerPage + index + 1;
                
                // 构建HTML
                row.innerHTML = `
                    <td>${sequentialId}</td>
                    <td>${sourceTypeBadge}</td>
                    <td title="${record.source_name || '无文件名'}">${sourceName}</td>
                    <td>${resultBadge}</td>
                    <td>${record.timestamp}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-primary preview-btn" data-id="${record.id}" title="查看详情">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${record.id}" title="删除记录">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                // 添加到表格
                recordsTableBody.appendChild(row);
            });
            
            // 添加预览点击事件
            document.querySelectorAll('.preview-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const recordId = this.getAttribute('data-id');
                    previewRecord(recordId);
                });
            });
            
            // 添加删除点击事件
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const recordId = this.getAttribute('data-id');
                    if (confirm('确定要删除此记录吗？此操作不可恢复。')) {
                        deleteRecord(recordId);
                    }
                });
            });
        }
        
        // 渲染分页函数
        function renderPagination(paginationData) {
            pagination.innerHTML = '';
            
            // 上一页按钮
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${!paginationData.has_prev ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" ${!paginationData.has_prev ? 'tabindex="-1" aria-disabled="true"' : ''}>上一页</a>`;
            pagination.appendChild(prevLi);
            
            // 如果总页数太多，显示部分页码
            const maxPagesToShow = 5;
            let startPage = Math.max(1, paginationData.page - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(paginationData.total_pages, startPage + maxPagesToShow - 1);
            
            // 调整startPage，确保显示maxPagesToShow个页码
            if (endPage - startPage + 1 < maxPagesToShow && startPage > 1) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
            
            // 添加第一页按钮（如果不在显示范围内）
            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                firstLi.innerHTML = '<a class="page-link" href="#">1</a>';
                pagination.appendChild(firstLi);
                
                // 如果需要，添加省略号
                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<a class="page-link" href="#" tabindex="-1" aria-disabled="true">...</a>';
                    pagination.appendChild(ellipsisLi);
                }
            }
            
            // 添加页码按钮
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === paginationData.page ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pagination.appendChild(pageLi);
            }
            
            // 添加最后一页按钮（如果不在显示范围内）
            if (endPage < paginationData.total_pages) {
                // 如果需要，添加省略号
                if (endPage < paginationData.total_pages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<a class="page-link" href="#" tabindex="-1" aria-disabled="true">...</a>';
                    pagination.appendChild(ellipsisLi);
                }
                
                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                lastLi.innerHTML = `<a class="page-link" href="#">${paginationData.total_pages}</a>`;
                pagination.appendChild(lastLi);
            }
            
            // 下一页按钮
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${!paginationData.has_next ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" ${!paginationData.has_next ? 'tabindex="-1" aria-disabled="true"' : ''}>下一页</a>`;
            pagination.appendChild(nextLi);
            
            // 添加页码点击事件
            document.querySelectorAll('.pagination .page-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    if (this.textContent === '上一页' && paginationData.has_prev) {
                        loadRecords(paginationData.page - 1);
                    } else if (this.textContent === '下一页' && paginationData.has_next) {
                        loadRecords(paginationData.page + 1);
                    } else if (this.textContent !== '...' && this.textContent !== '上一页' && this.textContent !== '下一页') {
                        loadRecords(parseInt(this.textContent));
                    }
                });
            });
        }
        
        // 判断文件是否是视频
        function isVideoFile(filename) {
            if (!filename) return false;
            const videoExtensions = ['mp4', 'webm', 'ogg', 'mov', 'avi', 'wmv', 'flv', 'mkv'];
            const ext = filename.split('.').pop().toLowerCase();
            return videoExtensions.includes(ext);
        }
        
        // 预览记录函数
        function previewRecord(recordId) {
            // 显示加载中
            document.getElementById('previewTitle').textContent = '加载详情中...';
            previewModal.style.display = 'block';
            
            // 重置所有媒体容器的显示状态
            resetMediaContainers();
            
            // 获取表格中显示的序号
            let displayId = null;
            document.querySelectorAll('#recordsTableBody tr').forEach(row => {
                const btnId = row.querySelector('.preview-btn')?.getAttribute('data-id');
                if (btnId === recordId.toString()) {
                    displayId = row.querySelector('td:first-child').textContent;
                }
            });
            
            // 请求详情数据
            fetch(`/api/detection_records/${recordId}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const record = result.data;
                        
                        // 更新模态框标题，使用表格中的序号而不是数据库ID
                        document.getElementById('previewTitle').textContent = '检测记录详情 #' + (displayId || record.id);
                        
                        // 判断是否为视频文件（改进的文件类型判断）
                        let isVideo = false;
                        let originalMimeType = 'video/mp4'; // 默认MIME类型
                        let resultMimeType = 'video/mp4';   // 默认MIME类型
                        
                        // 1. 先通过文件名判断
                        if (record.source_name) {
                            isVideo = isVideoFile(record.source_name);
                        }
                        
                        // 2. 如果URL存在但文件名未能确定类型，通过URL再次检查
                        if (record.original_url) {
                            const videoExtensions = ['mp4', 'webm', 'ogg', 'mov', 'avi', 'wmv', 'flv', 'mkv'];
                            const urlExt = record.original_url.split('.').pop().toLowerCase();
                            
                            if (videoExtensions.includes(urlExt)) {
                                isVideo = true;
                                
                                // 设置正确的MIME类型
                                switch (urlExt) {
                                    case 'webm':
                                        originalMimeType = 'video/webm';
                                        break;
                                    case 'ogg':
                                        originalMimeType = 'video/ogg';
                                        break;
                                    case 'mp4':
                                        originalMimeType = 'video/mp4';
                                        break;
                                    default:
                                        originalMimeType = `video/${urlExt}`;
                                }
                            }
                        }
                        
                        // 为结果文件设置MIME类型
                        if (record.result_url) {
                            const urlExt = record.result_url.split('.').pop().toLowerCase();
                            switch (urlExt) {
                                case 'webm':
                                    resultMimeType = 'video/webm';
                                    break;
                                case 'ogg':
                                    resultMimeType = 'video/ogg';
                                    break;
                                case 'mp4':
                                    resultMimeType = 'video/mp4';
                                    break;
                                default:
                                    resultMimeType = `video/${urlExt}`;
                            }
                        }
                        
                        // 3. 如果检测类型是视频或相机录像，强制设为视频类型
                        if (record.source_type === 'video' || record.source_type === 'camera') {
                            isVideo = true;
                        }
                        
                        // 设置媒体预览
                        if (isVideo) {
                            // 视频预览
                            if (record.original_url || record.original_path) {
                                videoPreview.style.display = 'block';
                                
                                // 尝试使用备选路径
                                // 1. 首先使用原始路径，从数据库中获取
                                let videoSrc = record.original_url || '';
                                
                                // 2. 如果API返回了original_path字段，尝试转换为可访问URL
                                if (record.original_path && !videoSrc.startsWith('/static')) {
                                    // 原始路径一般是相对于static目录的路径
                                    // 例如：static/uploads/camera/filename.webm
                                    // 需要转换为：/static/uploads/camera/filename.webm
                                    const pathParts = record.original_path.split('/');
                                    if (pathParts[0] === 'static') {
                                        // 直接添加斜杠前缀转为URL路径
                                        videoSrc = '/' + record.original_path;
                                    } else {
                                        // 如果不是以static开头，直接使用
                                        videoSrc = '/static/' + record.original_path;
                                    }
                                }
                                
                                // 创建source元素并设置错误处理
                                const source = document.createElement('source');
                                source.src = videoSrc;
                                source.type = originalMimeType;
                                
                                // 在控制台输出用于调试
                                console.log('使用原始视频路径:', videoSrc);
                                
                                // 错误处理函数
                                source.onerror = function() {
                                    console.error('视频源加载失败:', videoSrc);
                                    
                                    // 尝试使用不带斜杠的路径
                                    if (videoSrc.startsWith('/static')) {
                                        const noSlashSrc = videoSrc.substring(1); // 去掉开头的斜杠
                                        console.log('尝试使用不带斜杠的路径:', noSlashSrc);
                                        
                                        // 尝试完整URL路径
                                        const fullUrlSrc = window.location.origin + videoSrc;
                                        console.log('尝试使用完整URL路径:', fullUrlSrc);
                                        
                                        // 优先使用完整URL
                                        const altSource = document.createElement('source');
                                        altSource.src = fullUrlSrc;
                                        altSource.type = originalMimeType;
                                        
                                        // 为备用源设置错误处理
                                        altSource.onerror = function() {
                                            console.error('完整URL路径加载失败:', fullUrlSrc);
                                            
                                            // 退回到不带斜杠的路径
                                            const altSource2 = document.createElement('source');
                                            altSource2.src = noSlashSrc;
                                            altSource2.type = originalMimeType;
                                            
                                            altSource2.onerror = function() {
                                                console.error('不带斜杠的路径也加载失败:', noSlashSrc);
                                                
                                                // 如果有原始路径但URL加载失败，尝试直接使用原始路径
                                                if (record.original_path) {
                                                    // 构建完整的URL，确保没有admin前缀
                                                    const pathWithoutAdmin = record.original_path.replace(/^admin\//, '');
                                                    const fullPathSrc = window.location.origin + '/' + pathWithoutAdmin;
                                                    console.log('尝试完整原始路径URL:', fullPathSrc);
                                                    
                                                    const pathSource = document.createElement('source');
                                                    pathSource.src = fullPathSrc;
                                                    pathSource.type = originalMimeType;
                                                    
                                                    pathSource.onerror = function() {
                                                        console.error('完整原始路径加载失败:', fullPathSrc);
                                                        
                                                        // 最后尝试不带origin的原始路径
                                                        const finalSrc =  pathWithoutAdmin;
                                                        console.log('尝试最终路径:', finalSrc);
                                                        
                                                        const finalSource = document.createElement('source');
                                                        finalSource.src = finalSrc;
                                                        finalSource.type = originalMimeType;
                                                        
                                                        finalSource.onerror = function() {
                                                            console.error('所有路径都加载失败');
                                                            originalVideoContainer.innerHTML = `
                                                                <div class="alert alert-danger">
                                                                    视频加载失败，请检查文件路径或格式。<br>
                                                                    <small>尝试路径: ${videoSrc}<br>
                                                                    完整URL: ${fullUrlSrc}<br>
                                                                    去斜杠: ${noSlashSrc}<br>
                                                                    原始路径: ${fullPathSrc}<br>
                                                                    最终路径: ${finalSrc}</small>
                                                                </div>
                                                            `;
                                                        };
                                                        
                                                        originalVideo.innerHTML = '';
                                                        originalVideo.appendChild(finalSource);
                                                        originalVideo.load();
                                                    };
                                                    
                                                    originalVideo.innerHTML = '';
                                                    originalVideo.appendChild(pathSource);
                                                    originalVideo.load();
                                                } else {
                                                    // 没有原始路径
                                                    originalVideoContainer.innerHTML = `
                                                        <div class="alert alert-danger">
                                                            视频加载失败，请检查文件路径或格式。<br>
                                                            <small>尝试路径: ${videoSrc}<br>
                                                            完整URL: ${fullUrlSrc}<br>
                                                            去斜杠: ${noSlashSrc}</small>
                                                        </div>
                                                    `;
                                                }
                                            };
                                            
                                            originalVideo.innerHTML = '';
                                            originalVideo.appendChild(altSource2);
                                            originalVideo.load();
                                        };
                                        
                                        originalVideo.innerHTML = '';
                                        originalVideo.appendChild(altSource);
                                        originalVideo.load();
                                    } else if (record.original_path) {
                                        // 如果当前不是以/static开头，但有原始路径
                                        // 直接尝试使用原始路径（不带斜杠）
                                        const plainSrc = record.original_path;
                                        console.log('尝试使用原始路径(无斜杠):', plainSrc);
                                        
                                        const plainSource = document.createElement('source');
                                        plainSource.src = plainSrc;
                                        plainSource.type = originalMimeType;
                                        
                                        plainSource.onerror = function() {
                                            originalVideoContainer.innerHTML = `
                                                <div class="alert alert-danger">
                                                    视频加载失败，请检查文件路径或格式。<br>
                                                    尝试路径: ${videoSrc}<br>
                                                    备用路径: ${plainSrc}
                                                </div>
                                            `;
                                        };
                                        
                                        originalVideo.innerHTML = '';
                                        originalVideo.appendChild(plainSource);
                                        originalVideo.load();
                                    } else {
                                        // 没有备选路径，显示错误信息
                                        originalVideoContainer.innerHTML = `
                                            <div class="alert alert-danger">
                                                视频加载失败，请检查文件路径或格式。<br>
                                                尝试路径: ${videoSrc}
                                            </div>
                                        `;
                                    }
                                };
                                
                                // 清空并添加新的source
                                originalVideo.innerHTML = '';
                                originalVideo.appendChild(source);
                                
                                // 尝试加载视频
                                originalVideo.load();
                            } else {
                                noMediaPlaceholder.style.display = 'block';
                            }
                            
                            if (record.result_url || record.result_path) {
                                resultVideoPreview.style.display = 'block';
                                
                                // 尝试使用备选路径
                                // 1. 首先使用结果URL，从数据库中获取
                                let videoSrc = record.result_url || '';
                                
                                // 2. 如果API返回了result_path字段，尝试转换为可访问URL
                                if (record.result_path && !videoSrc.startsWith('/static')) {
                                    // 结果路径一般是相对于static目录的路径
                                    const pathParts = record.result_path.split('/');
                                    if (pathParts[0] === 'static') {
                                        // 直接添加斜杠前缀转为URL路径
                                        videoSrc = '/' + record.result_path;
                                    } else {
                                        // 如果不是以static开头，直接使用
                                        videoSrc = '/static/' + record.result_path;
                                    }
                                }
                                
                                // 创建source元素并设置错误处理
                                const source = document.createElement('source');
                                source.src = videoSrc;
                                source.type = resultMimeType;
                                
                                // 在控制台输出用于调试
                                console.log('使用结果视频路径:', videoSrc);
                                
                                // 错误处理函数
                                source.onerror = function() {
                                    console.error('结果视频源加载失败:', videoSrc);
                                    
                                    // 尝试使用不带斜杠的路径
                                    if (videoSrc.startsWith('/static')) {
                                        const noSlashSrc = videoSrc.substring(1); // 去掉开头的斜杠
                                        console.log('尝试使用不带斜杠的路径:', noSlashSrc);
                                        
                                        // 尝试完整URL路径
                                        const fullUrlSrc = window.location.origin + videoSrc;
                                        console.log('尝试使用完整URL路径:', fullUrlSrc);
                                        
                                        // 优先使用完整URL
                                        const altSource = document.createElement('source');
                                        altSource.src = fullUrlSrc;
                                        altSource.type = resultMimeType;
                                        
                                        // 为备用源设置错误处理
                                        altSource.onerror = function() {
                                            console.error('完整URL路径加载失败:', fullUrlSrc);
                                            
                                            // 退回到不带斜杠的路径
                                            const altSource2 = document.createElement('source');
                                            altSource2.src = noSlashSrc;
                                            altSource2.type = resultMimeType;
                                            
                                            altSource2.onerror = function() {
                                                console.error('不带斜杠的路径也加载失败:', noSlashSrc);
                                                
                                                // 如果有结果路径但URL加载失败，尝试直接使用结果路径
                                                if (record.result_path) {
                                                    // 构建完整的URL，确保没有admin前缀
                                                    const pathWithoutAdmin = record.result_path.replace(/^admin\//, '');
                                                    const fullPathSrc = window.location.origin + '/' + pathWithoutAdmin;
                                                    console.log('尝试完整结果路径URL:', fullPathSrc);
                                                    
                                                    const pathSource = document.createElement('source');
                                                    pathSource.src = fullPathSrc;
                                                    pathSource.type = resultMimeType;
                                                    
                                                    pathSource.onerror = function() {
                                                        console.error('完整结果路径加载失败:', fullPathSrc);
                                                        
                                                        // 最后尝试不带origin的结果路径
                                                        const finalSrc = '/' + pathWithoutAdmin;
                                                        console.log('尝试最终路径:', finalSrc);
                                                        
                                                        const finalSource = document.createElement('source');
                                                        finalSource.src = finalSrc;
                                                        finalSource.type = resultMimeType;
                                                        
                                                        finalSource.onerror = function() {
                                                            console.error('所有路径都加载失败');
                                                            resultVideoContainer.innerHTML = `
                                                                <div class="alert alert-danger">
                                                                    结果视频加载失败，请检查文件路径或格式。<br>
                                                                    <small>尝试路径: ${videoSrc}<br>
                                                                    完整URL: ${fullUrlSrc}<br>
                                                                    去斜杠: ${noSlashSrc}<br>
                                                                    结果路径: ${fullPathSrc}<br>
                                                                    最终路径: ${finalSrc}</small>
                                                                </div>
                                                            `;
                                                        };
                                                        
                                                        resultVideo.innerHTML = '';
                                                        resultVideo.appendChild(finalSource);
                                                        resultVideo.load();
                                                    };
                                                    
                                                    resultVideo.innerHTML = '';
                                                    resultVideo.appendChild(pathSource);
                                                    resultVideo.load();
                                                } else {
                                                    // 没有结果路径
                                                    resultVideoContainer.innerHTML = `
                                                        <div class="alert alert-danger">
                                                            结果视频加载失败，请检查文件路径或格式。<br>
                                                            <small>尝试路径: ${videoSrc}<br>
                                                            完整URL: ${fullUrlSrc}<br>
                                                            去斜杠: ${noSlashSrc}</small>
                                                        </div>
                                                    `;
                                                }
                                            };
                                            
                                            resultVideo.innerHTML = '';
                                            resultVideo.appendChild(altSource2);
                                            resultVideo.load();
                                        };
                                        
                                        resultVideo.innerHTML = '';
                                        resultVideo.appendChild(altSource);
                                        resultVideo.load();
                                    } else if (record.result_path) {
                                        // 如果当前不是以/static开头，但有结果路径
                                        // 直接尝试使用结果路径（不带斜杠）
                                        const plainSrc = record.result_path;
                                        console.log('尝试使用结果路径(无斜杠):', plainSrc);
                                        
                                        const plainSource = document.createElement('source');
                                        plainSource.src = plainSrc;
                                        plainSource.type = resultMimeType;
                                        
                                        plainSource.onerror = function() {
                                            resultVideoContainer.innerHTML = `
                                                <div class="alert alert-danger">
                                                    结果视频加载失败，请检查文件路径或格式。<br>
                                                    尝试路径: ${videoSrc}<br>
                                                    备用路径: ${plainSrc}
                                                </div>
                                            `;
                                        };
                                        
                                        resultVideo.innerHTML = '';
                                        resultVideo.appendChild(plainSource);
                                        resultVideo.load();
                                    } else {
                                        // 没有备选路径，显示错误信息
                                        resultVideoContainer.innerHTML = `
                                            <div class="alert alert-danger">
                                                结果视频加载失败，请检查文件路径或格式。<br>
                                                尝试路径: ${videoSrc}
                                            </div>
                                        `;
                                    }
                                };
                                
                                // 清空并添加新的source
                                resultVideo.innerHTML = '';
                                resultVideo.appendChild(source);
                                
                                // 尝试加载视频
                                resultVideo.load();
                            } else {
                                noResultPlaceholder.style.display = 'block';
                            }
                        } else {
                            // 图片预览
                            if (record.original_url) {
                                imagePreview.style.display = 'block';
                                originalImage.src = record.original_url;
                                
                                // 图片加载错误处理
                                originalImage.onerror = function() {
                                    console.error('图片加载失败:', record.original_url);
                                    this.onerror = null;
                                    this.src = ''; // 清空错误的src
                                    this.alt = '图片加载失败';
                                    imagePreview.innerHTML += '<p class="text-danger">图片加载失败</p>';
                                };
                            } else {
                                noMediaPlaceholder.style.display = 'block';
                            }
                            
                            if (record.result_url) {
                                resultImagePreview.style.display = 'block';
                                resultImage.src = record.result_url;
                                
                                // 结果图片加载错误处理
                                resultImage.onerror = function() {
                                    console.error('结果图片加载失败:', record.result_url);
                                    this.onerror = null;
                                    this.src = ''; // 清空错误的src
                                    this.alt = '图片加载失败';
                                    resultImagePreview.innerHTML += '<p class="text-danger">图片加载失败</p>';
                                };
                            } else {
                                noResultPlaceholder.style.display = 'block';
                            }
                        }
                        
                        // 设置基本信息
                        document.getElementById('detailId').textContent = record.id;
                        
                        // 检测类型
                        let typeText = '';
                        switch(record.source_type) {
                            case 'image':
                                typeText = '单张图片';
                                break;
                            case 'multi_image':
                                typeText = '批量图片';
                                break;
                            case 'video':
                                typeText = '视频';
                                break;
                            case 'camera':
                                typeText = '实时检测';
                                break;
                            default:
                                typeText = '未知类型';
                        }
                        document.getElementById('detailType').textContent = typeText;
                        
                        document.getElementById('detailFilename').textContent = record.source_name || '无文件名';
                        document.getElementById('detailTime').textContent = record.timestamp;
                        document.getElementById('detailUser').textContent = record.username;
                        document.getElementById('detailDuration').textContent = record.duration;
                        document.getElementById('detailObjects').textContent = record.total_objects;
                        document.getElementById('detailCleaned').textContent = record.is_cleaned ? '已清理' : '未清理';
                        
                        // 处理检测到的对象
                        const objectsSection = document.getElementById('objectsSection');
                        const objectList = document.getElementById('objectList');
                        
                        if (record.total_objects > 0 && record.detection_results && record.detection_results.objects) {
                            objectsSection.style.display = 'block';
                            objectList.innerHTML = '';
                            
                            record.detection_results.objects.forEach(obj => {
                                const objectItem = document.createElement('div');
                                objectItem.className = 'object-item';
                                objectItem.innerHTML = `
                                    <div>
                                        <strong>${obj.label}</strong>
                                    </div>
                                    <div>
                                        置信度: ${obj.confidence}%
                                    </div>
                                `;
                                objectList.appendChild(objectItem);
                            });
                        } else {
                            objectsSection.style.display = 'none';
                        }
                        
                        // 新增：垃圾坐标信息
                        const coordinatesSection = document.getElementById('coordinatesSection');
                        const coordinatesTableBody = document.getElementById('coordinatesTableBody');
                        
                        let objectsData = [];
                        
                        // 检查数据来源，可能有多种数据结构
                        if (record.detection_results) {
                            // 如果detection_results是字符串，尝试解析
                            const detectionResults = typeof record.detection_results === 'string' 
                                ? JSON.parse(record.detection_results) 
                                : record.detection_results;
                                
                            if (detectionResults.objects && detectionResults.objects.length > 0) {
                                objectsData = detectionResults.objects;
                            }
                        } else if (record.metadata && record.metadata.objects) {
                            // 备选：从metadata中获取
                            objectsData = record.metadata.objects;
                        }
                        
                        if (objectsData.length > 0) {
                            coordinatesSection.style.display = 'block';
                            coordinatesTableBody.innerHTML = '';
                            
                            objectsData.forEach((obj, index) => {
                                // 确保存在坐标数据
                                if (obj.x1 !== undefined && obj.y1 !== undefined && 
                                    obj.x2 !== undefined && obj.y2 !== undefined) {
                                    
                                    // 计算宽度和高度
                                    const width = obj.x2 - obj.x1;
                                    const height = obj.y2 - obj.y1;
                                    
                                    // 创建行
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>${index + 1}</td>
                                        <td>${obj.label || '未知类型'}</td>
                                        <td>${typeof obj.confidence === 'number' ? obj.confidence.toFixed(2) : obj.confidence}%</td>
                                        <td>(${Math.round(obj.x1)}, ${Math.round(obj.y1)})</td>
                                        <td>(${Math.round(obj.x2)}, ${Math.round(obj.y2)})</td>
                                        <td>${Math.round(width)} × ${Math.round(height)}</td>
                                    `;
                                    coordinatesTableBody.appendChild(row);
                                }
                            });
                        } else {
                            coordinatesSection.style.display = 'none';
                        }
                    } else {
                        console.error('获取记录详情失败:', result.message);
                        document.getElementById('previewTitle').textContent = '加载详情失败';
                    }
                })
                .catch(error => {
                    console.error('API请求错误:', error);
                    document.getElementById('previewTitle').textContent = '加载详情失败';
                });
        }
        
        // 重置媒体容器显示状态
        function resetMediaContainers() {
            // 清空图片源
            originalImage.src = '';
            resultImage.src = '';
            
            // 重置图片错误处理
            originalImage.onerror = null;
            resultImage.onerror = null;
            
            // 重置图片容器
            imagePreview.innerHTML = '';
            imagePreview.appendChild(originalImage);
            resultImagePreview.innerHTML = '';
            resultImagePreview.appendChild(resultImage);
            
            // 清空并暂停视频，然后创建新的视频元素
            if (originalVideo) {
                originalVideo.pause();
                originalVideo.innerHTML = '';
            }
            
            if (resultVideo) {
                resultVideo.pause();
                resultVideo.innerHTML = '';
            }
            
            // 创建新的视频元素以替换旧的（清除所有事件监听器）
            const newOriginalVideo = document.createElement('video');
            newOriginalVideo.id = 'originalVideo';
            newOriginalVideo.controls = true;
            newOriginalVideo.innerHTML = '您的浏览器不支持视频播放';
            
            const newResultVideo = document.createElement('video');
            newResultVideo.id = 'resultVideo';
            newResultVideo.controls = true;
            newResultVideo.innerHTML = '您的浏览器不支持视频播放';
            
            // 重置视频容器
            originalVideoContainer.innerHTML = '';
            originalVideoContainer.appendChild(newOriginalVideo);
            
            resultVideoContainer.innerHTML = '';
            resultVideoContainer.appendChild(newResultVideo);
            
            // 更新视频元素引用
            originalVideo = newOriginalVideo;
            resultVideo = newResultVideo;
            
            // 隐藏所有容器
            imagePreview.style.display = 'none';
            videoPreview.style.display = 'none';
            noMediaPlaceholder.style.display = 'none';
            resultImagePreview.style.display = 'none';
            resultVideoPreview.style.display = 'none';
            noResultPlaceholder.style.display = 'none';
            
            // 重置坐标信息容器
            document.getElementById('coordinatesSection').style.display = 'none';
            document.getElementById('coordinatesTableBody').innerHTML = '';
            
            // 重置标签状态
            document.querySelectorAll('.media-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.media-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 激活第一个标签
            document.querySelector('.media-tab').classList.add('active');
            document.getElementById('originalMedia').classList.add('active');
        }
        
        // 删除记录函数
        function deleteRecord(recordId) {
            fetch(`/api/delete_record/${recordId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('记录删除成功');
                    loadRecords(currentPage);  // 重新加载当前页
                } else {
                    alert('删除失败: ' + result.message);
                }
            })
            .catch(error => {
                console.error('API请求错误:', error);
                alert('API请求错误: ' + error);
            });
        }
        
        // 导出记录函数
        function exportRecords() {
            // 获取当前筛选条件
            const sourceType = sourceTypeFilter.value;
            const hasObjects = resultFilter.value;
            const search = searchInput.value.trim();
            
            // 构建导出URL
            let url = `/api/export_records?format=csv`;
            if (sourceType) url += `&source_type=${sourceType}`;
            if (hasObjects) url += `&has_objects=${hasObjects}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            
            // 创建隐藏的下载链接
            const link = document.createElement('a');
            link.href = url;
            link.download = `检测记录_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    });
</script>
{% endblock %} 